<!DOCTYPE html>
<html>
<head>
	<title>Escape</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
</head>
<body style="overscroll-behavior: none;overflow: hidden;">
	<script type="text/javascript">
		var MARK = "EscapeChatV1.0"
		var firstloaded;
		var room;
		var domain = "hardrelice.gitee.io/pages/works"
		// var domain = "192.168.0.100:8081"
		// handle userName arrangement here
		var userName = 'FILT'+String(new Date().getTime())+String(parseInt(Math.random()*1000))
		var ifr = document.createElement('iframe');
		document.body.style.margin = "0"
		ifr.style.opacity = "0";
		ifr.style.width = "0";
		ifr.style.height = "0";
		ifr.style.border = "none";

		var ifrMain = document.createElement('iframe');
		ifrMain.style.opacity = "0"
		ifrMain.style.width = window.innerWidth+'px';
		ifrMain.style.height = window.innerHeight+'px';
		ifrMain.style.border = "none";
		window.onresize = () => {
			ifrMain.style.width = window.innerWidth+'px';
			ifrMain.style.height = window.innerHeight+'px';
		}
		document.body.appendChild(ifr)
		document.body.appendChild(ifrMain)
		// ifr.onload = () => {
			
		// }
		window.onload = () => {
			if (location.hash) {
				room = MARK+location.hash.substr(1);
			} else {
				while(!room){
					let tempRoom = prompt('Room:', room);
					if (tempRoom !== null) {
						room = MARK+tempRoom;
						ifr.src = "https://"+domain+'/escape/ws.html?'+room+'#'+userName
						ifr.onload = () => {
							if (firstloaded) {
								return
							}
							firstloaded = true
							loop = () => {
								if(ifr.contentWindow.USERCHECKED){
									console.log('ok')
									let users = ifr.contentWindow.onlineUsers
									let hostOnline = ifr.contentWindow.HOSTONLINE
									if (!hostOnline) {
										userName = ifr.contentWindow.SYSTEMNAME
										ifrMain.src = "https://"+domain+'/escape/ws.html?'+room+'#'+userName
										ifrMain.style.opacity = 1
									} else if (users.length < 4) {
										for (var i = 0; i < 4; i++) {
											if(users.indexOf(['A','B','C','D'][i])=='-1'){
												userName = ['A','B','C','D'][i]
												ifrMain.src = "https://"+domain+'/escape/ws.html?'+room+'#'+userName
												
												break
											}
										}
										ifrMain.style.opacity = 1
									}
								}else{
									setTimeout(function() {
										loop()
									}, 500);
								}
							}
							loop()
						}
						// ifr.onload = ()=> {
						// 	setTimeout(function() {
						// 		ifr.contentDocument.querySelector('#messages').children[1].remove()
						// 		ifr.contentDocument.querySelector('#sidebar').remove()
						// 	}, 3000);
						// }
						break
					} else {
						continue
					}
				}
			}
		}

		
		

	</script>
</body>
</html>